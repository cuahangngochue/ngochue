{% extends "base.html" %}

{% block title %}Quản lý Khách hàng{% endblock %}

{% block content %}
<h2 class="mb-4">
    Quản lý khách hàng
    <span id="totalCustomersDisplay" class="badge bg-secondary ms-2"></span>
</h2>

<div class="row mb-3 align-items-center">
    <div class="col-md-9">
        <div class="input-group">
            <input type="text" class="form-control" id="customerSearchInput"
                placeholder="Tìm kiếm theo tên khách hàng...">
            <button class="btn btn-outline-secondary" type="button" id="customerSearchBtn">Tìm</button>
        </div>
    </div>
    <div class="col-md-3 text-end"> <button type="button" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#customerModal" id="addCustomerBtn">
            Thêm Khách hàng mới
        </button>
    </div>
</div>
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>Mã KH</th>
                <th>Tên Khách hàng</th>
                <th>Địa chỉ/SĐT</th>
                <th>Tổng Tiền hàng
                    (Tổng các HĐ)
                </th>
                <th>Tổng CK
                    (Tổng các HĐ)
                </th>
                <th>Đã Thanh toán
                    (Tổng các HĐ)
                </th>
                <th>Công nợ</th>
                <th>Ghi chú</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="customersTableBody">
            <tr>
                <td colspan="10" class="text-center">Đang tải dữ liệu...</td>
            </tr>
        </tbody>
    </table>
</div>

<nav aria-label="Customer pagination" class="mt-3">
    <ul class="pagination justify-content-center" id="customerPaginationControls">
    </ul>
</nav>
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Thêm/Sửa Khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerMakh">
                    <div class="mb-3">
                        <label for="customerTenkh" class="form-label">Tên Khách hàng</label>
                        <input type="text" class="form-control" id="customerTenkh" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerDiachiSdt" class="form-label">Địa chỉ/SĐT</label>
                        <input type="text" class="form-control" id="customerDiachiSdt">
                    </div>
                    <div class="mb-3">
                        <label for="customerGhichu" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="customerGhichu" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="customerInvoicesModal" tabindex="-1" aria-labelledby="customerInvoicesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerInvoicesModalLabel">Hóa đơn của Khách hàng: <span
                        id="customerInvoicesModalCustomerName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped table-sm">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllInvoices"></th>
                                <th>Mã HĐ</th>
                                <th>Ngày lập</th>
                                <th>Còn nợ</th>
                            </tr>
                        </thead>
                        <tbody id="customerInvoicesTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Đang tải hóa đơn...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-end">
                    <strong>Tổng số tiền nợ đã chọn: <span id="totalSelectedDebt" class="text-danger fw-bold">0
                            đ</span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmPayBtn">Thanh toán đã chọn</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
    // Định nghĩa các biến toàn cục cho phân trang khách hàng
    let currentCustomerPage = 1; // Trang hiện tại cho khách hàng
    const customerItemsPerPage = 10; // Số lượng khách hàng trên mỗi trang (có thể điều chỉnh)
    let totalCustomers = 0; // Tổng số khách hàng từ API
    let currentCustomerInvoicePage = 1;
    const customerInvoiceItemsPerPage = 10; // Số lượng hóa đơn trên mỗi trang trong modal
    let currentCustomerIdForInvoices = null; // Lưu trữ mã khách hàng đang xem hóa đơn
    async function fetchCustomers(page = currentCustomerPage, searchQuery = '') {
        // Cập nhật trang hiện tại
        currentCustomerPage = page;
        const skip = (currentCustomerPage - 1) * customerItemsPerPage;

        try {
            let url = `/customers/?skip=${skip}&limit=${customerItemsPerPage}`;
            if (searchQuery) {
                url += `&search=${encodeURIComponent(searchQuery)}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch customers');
            }

            const data = await response.json();
            const customers = data.customers;
            totalCustomers = data.total_count;

            $('#totalCustomersDisplay').text(totalCustomers);

            const tableBody = $('#customersTableBody');
            tableBody.empty();

            if (customers.length === 0) {
                tableBody.append('<tr><td colspan="10" class="text-center">Chưa có khách hàng nào.</td></tr>');
                $('#customerPaginationControls').empty();
                $('#totalCustomersDisplay').text('0');
                return;
            }

            customers.forEach(customer => {
                const connoClass = (customer.conno && customer.conno > 0) ? 'text-danger fw-bold' : '';
                const row = `
            <tr>
                <td>${customer.makh}</td>
                <td>${customer.tenkh}</td>
                <td>${customer.diachi_sdt || ''}</td>
                <td>${formatCurrency(customer.tongtienhang, 0)}</td>
                <td>${formatCurrency(customer.tongchietkhau, 0)}</td>
                <td>${formatCurrency(customer.khhdathanhtoan, 0)}</td>
                <td class="${connoClass}">${formatCurrency(customer.conno, 0)}</td>
                <td>${customer.ghichu || ''}</td>
                <td>
                    <button type="button" class="btn btn-warning btn-sm edit-customer-btn"
                        data-makh="${customer.makh}"
                        data-tenkh="${customer.tenkh}"
                        data-diachisdt="${customer.diachi_sdt || ''}"
                        data-ghichu="${customer.ghichu || ''}"
                        data-bs-toggle="modal" data-bs-target="#customerModal">Sửa</button>

                    ${customer.conno > 0 ? `<button type="button" class="btn btn-success btn-sm pay-invoice-btn ms-2"
                        data-makh="${customer.makh}"
                        data-tenkh="${customer.tenkh}">Thanh toán</button>` : ''}
                </td>
            </tr>
            `;
                tableBody.append(row);
            });

            renderCustomerPaginationControls();

        } catch (error) {
            console.error('Error fetching customers:', error);
            $('#customersTableBody').html('<tr><td colspan="10" class="text-danger text-center">Lỗi tải dữ liệu khách hàng.</td></tr>');
            $('#customerPaginationControls').empty();
            $('#totalCustomersDisplay').text('Lỗi');
        }
    }

    function updateTotalSelectedDebt() {
        let totalDebt = 0;
        // Duyệt qua tất cả các checkbox đã được chọn
        $('#customerInvoicesTableBody .invoice-checkbox:checked').each(function () {
            // Lấy giá trị của thuộc tính data-debt
            const debt = parseFloat($(this).data('debt'));
            if (!isNaN(debt)) {
                totalDebt += debt;
            }
        });
        // Cập nhật hiển thị tổng số tiền
        $('#totalSelectedDebt').text(formatCurrency(totalDebt));
    }
    // Hàm renderPaginationControls đã được điều chỉnh cho khách hàng
    function renderCustomerPaginationControls() {
        const totalPages = Math.ceil(totalCustomers / customerItemsPerPage);
        const paginationControls = $('#customerPaginationControls'); // ID mới cho phân trang khách hàng
        paginationControls.empty(); // Xóa các nút cũ

        if (totalPages <= 1) {
            return; // Không cần phân trang nếu chỉ có 1 trang hoặc ít hơn
        }

        // Nút "Trước"
        paginationControls.append(`<li class="page-item ${currentCustomerPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentCustomerPage - 1}">Trước</a></li>`);

        // Logic để hiển thị các nút số trang (bao gồm dấu "...")
        const pageRange = 5; // Số lượng trang hiển thị xung quanh trang hiện tại
        let startPage = Math.max(1, currentCustomerPage - Math.floor(pageRange / 2));
        let endPage = Math.min(totalPages, currentCustomerPage + Math.ceil(pageRange / 2) - 1);

        // Điều chỉnh startPage và endPage để luôn có pageRange số trang nếu có đủ
        if (endPage - startPage + 1 < pageRange) {
            if (currentCustomerPage - startPage < Math.floor(pageRange / 2)) {
                endPage = Math.min(totalPages, startPage + pageRange - 1);
            } else if (endPage - currentCustomerPage < Math.ceil(pageRange / 2) - 1) {
                startPage = Math.max(1, endPage - pageRange + 1);
            }
        }

        // Luôn hiển thị trang đầu tiên
        if (startPage > 1) {
            paginationControls.append(`<li class="page-item ${1 === currentCustomerPage ? 'active' : ''}"><a class="page-link" href="#" data-page="1">1</a></li>`);
            if (startPage > 2) {
                paginationControls.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }
        }

        // Hiển thị các trang trong phạm vi tính toán
        for (let i = startPage; i <= endPage; i++) {
            let activeClass = i === currentCustomerPage ? 'active' : '';
            paginationControls.append(`<li class="page-item ${activeClass}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`);
        }

        // Luôn hiển thị trang cuối cùng
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationControls.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }
            paginationControls.append(`<li class="page-item ${totalPages === currentCustomerPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`);
        }

        // Nút "Sau"
        paginationControls.append(`<li class="page-item ${currentCustomerPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentCustomerPage + 1}">Sau</a></li>`);

        // Xử lý sự kiện click cho các nút phân trang
        paginationControls.off('click', '.page-link').on('click', '.page-link', function (e) {
            e.preventDefault();
            const newPage = parseInt($(this).data('page'));
            if (!isNaN(newPage) && newPage > 0 && newPage <= totalPages && newPage !== currentCustomerPage) {
                currentCustomerPage = newPage; // Cập nhật trang hiện tại
                fetchCustomers(currentCustomerPage, $('#customerSearchInput').val()); // Gọi lại fetchCustomers
            }
        });
    }
    let selectedCustomerId = null;
    async function fetchCustomerInvoices(makh) {
        try {
            const url = `/customers/${makh}/unsettled_invoices`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('Failed to fetch invoices');
            }

            const invoices = await response.json();
            const tableBody = $('#customerInvoicesTableBody');
            tableBody.empty();
            $('#totalSelectedDebt').text('0 đ'); // Reset tổng tiền nợ
            $('#selectAllInvoices').prop('checked', false); // Bỏ chọn tất cả

            if (invoices.length === 0) {
                tableBody.append('<tr><td colspan="4" class="text-center">Không có hóa đơn nào cần thanh toán.</td></tr>');
            } else {
                invoices.forEach(invoice => {
                    const row = `
                    <tr>
                        <td>
                            <input type="checkbox" class="invoice-checkbox" value="${invoice.mahd}" data-debt="${invoice.conno}">
                        </td>
                        <td>${invoice.mahd}</td>
                        <td>${new Date(invoice.created_at).toLocaleDateString()}</td>
                        <td class="text-danger fw-bold">${formatCurrency(invoice.conno)}</td>
                    </tr>
                `;
                    tableBody.append(row);
                });
            }
        } catch (error) {
            console.error('Error fetching customer invoices:', error);
            $('#customerInvoicesTableBody').html('<tr><td colspan="4" class="text-danger text-center">Lỗi tải hóa đơn.</td></tr>');
        }
    }
    $(document).ready(function () {
        fetchCustomers(); // Tải khách hàng ban đầu (sẽ tải trang 1 mặc định)
        $(document).on('click', '.pay-invoice-btn', function () {
            const makh = $(this).data('makh');
            const tenkh = $(this).data('tenkh');

            selectedCustomerId = makh; // Lưu mã KH đang được chọn
            $('#customerInvoicesModalCustomerName').text(tenkh); // Hiển thị tên KH trên modal

            // Gọi hàm để tải và hiển thị danh sách hóa đơn còn nợ
            fetchCustomerInvoices(makh);

            // Mở modal hóa đơn
            const invoiceModal = new bootstrap.Modal(document.getElementById('customerInvoicesModal'));
            invoiceModal.show();
        });

        // Xử lý sự kiện click cho nút "Thanh toán đã chọn" trong modal
        $('#confirmPayBtn').on('click', async function () {
            const selectedInvoiceIds = [];
            // Lấy tất cả các checkbox đã được chọn
            $('#customerInvoicesTableBody .invoice-checkbox:checked').each(function () {
                const mahdValue = $(this).val();

                // Thêm log để kiểm tra giá trị thô
                console.log('Giá trị Mahd của checkbox đã chọn:', mahdValue);

                // Trích xuất phần số từ chuỗi mã hóa đơn
                const numericPart = mahdValue.match(/\d+/g);
                if (numericPart && numericPart.length > 0) {
                    // Chuyển đổi thành số nguyên và thêm vào mảng
                    selectedInvoiceIds.push(mahdValue);
                }
            });

            // Thêm log để kiểm tra payload cuối cùng
            console.log('Payload gửi lên server:', selectedInvoiceIds); 

            console.log('Payload gửi lên server:', selectedInvoiceIds);

            if (selectedInvoiceIds.length === 0) {
                alert('Vui lòng chọn ít nhất một hóa đơn để thanh toán.');
                return;
            }
            console.log('Payload gửi lên server:', selectedInvoiceIds); // Thêm dòng này
            // Gọi API thanh toán đã tạo ở phần back-end
            try {
                const response = await fetch(`/customers/${selectedCustomerId}/pay_invoices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selectedInvoiceIds)
                });

                const result = await response.json();

                if (!response.ok) {
                    alert(`Lỗi: ${result.detail || 'Không xác định'}`);
                } else {
                    alert(result.message);
                    // Đóng modal
                    const invoiceModal = bootstrap.Modal.getInstance(document.getElementById('customerInvoicesModal'));
                    invoiceModal.hide();

                    // Tải lại danh sách khách hàng để cập nhật dữ liệu
                    fetchCustomers(currentCustomerPage, $('#customerSearchInput').val());
                }
            } catch (error) {
                console.error('Error during payment:', error);
                alert('Đã xảy ra lỗi khi thanh toán. Vui lòng thử lại.');
            }
        });

        // Xử lý checkbox "chọn tất cả"
        $('#selectAllInvoices').on('change', function () {
            $('.invoice-checkbox').prop('checked', this.checked);
            // Cập nhật tổng số tiền nợ (bạn cần có hàm này)
            updateTotalSelectedDebt();
        });

        // Xử lý sự kiện khi một checkbox hóa đơn thay đổi
        $(document).on('change', '.invoice-checkbox', function () {
            // Cập nhật tổng số tiền nợ (bạn cần có hàm này)
            updateTotalSelectedDebt();
        });
        $('#addCustomerBtn').on('click', function () {
            $('#customerModalLabel').text('Thêm Khách hàng mới');
            $('#customerForm')[0].reset(); // Clear form
            $('#customerMakh').val(''); // Clear hidden ID
        });

        // Handle Edit Customer Button click (delegated event for dynamic rows)
        $(document).on('click', '.edit-customer-btn', function () {
            $('#customerModalLabel').text('Sửa Khách hàng');
            $('#customerMakh').val($(this).data('makh'));
            $('#customerTenkh').val($(this).data('tenkh'));
            $('#customerDiachiSdt').val($(this).data('diachisdt'));
            $('#customerGhichu').val($(this).data('ghichu'));
        });

        // Handle Form Submission
        $('#customerForm').on('submit', async function (e) {
            e.preventDefault();
            const makh = $('#customerMakh').val();
            const customerData = {
                tenkh: $('#customerTenkh').val(),
                diachi_sdt: $('#customerDiachiSdt').val(),
                ghichu: $('#customerGhichu').val()
            };

            let url = '/customers/';
            let method = 'POST';

            if (makh) { // If makh exists, it's an update
                url += makh; // Assuming API endpoint is /customers/{makh} for PUT
                method = 'PUT';
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Lỗi: ${errorData.detail}`);
                    return;
                }

                alert(`Khách hàng đã được ${makh ? 'cập nhật' : 'thêm mới'} thành công!`);
                $('#customerModal').modal('hide'); // Hide the modal

                // Sau khi thêm/sửa, gọi lại fetchCustomers với giá trị tìm kiếm và trang hiện tại
                const currentSearchQuery = $('#customerSearchInput').val();
                fetchCustomers(currentCustomerPage, currentSearchQuery); // Refresh the list with current search
            } catch (error) {
                console.error('Error submitting customer form:', error);
                alert('Đã xảy ra lỗi. Vui lòng thử lại.');
            }
        });
        $('#customerModal').on('hidden.bs.modal', function () {
            // Xóa focus khỏi tất cả các phần tử có thể nhận focus trong modal
            $(this).find(':focus').blur();

            // Chuyển focus về body của trang để đảm bảo không còn lỗi
            $('body').focus();
        });
        // Handle search button click
        $('#customerSearchBtn').on('click', function () {
            currentCustomerPage = 1; // Reset về trang 1 khi tìm kiếm mới
            const searchQuery = $('#customerSearchInput').val();
            fetchCustomers(currentCustomerPage, searchQuery);
        });

        // Optional: Handle search input enter key press
        $('#customerSearchInput').on('keypress', function (e) {
            if (e.which === 13) { // Enter key
                e.preventDefault(); // Prevent form submission if input is inside a form
                currentCustomerPage = 1; // Reset về trang 1 khi tìm kiếm mới
                const searchQuery = $('#customerSearchInput').val();
                fetchCustomers(currentCustomerPage, searchQuery);
            }
        });
    });
</script>
{% endblock %}
